<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>中国大学排行榜</title>
  <link rel = "stylesheet" href = "css/themecss.css">
  <link rel="stylesheet" href="font-awesome-4.3.0/css/font-awesome.min.css">
  <!--pure css-->
  <link rel="stylesheet" href="css/pure-min.css">
  <link rel="stylesheet" href="css/side-menu.css">
  <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
    <script src="js/jquery-1.4.js"></script>
  <!--D3 js-->
    <script type="text/javascript" src="./exampleData/treemap.d3.js"></script>
    <script type="text/javascript" src="./exampleData/treemap.d3.layout.js"></script>
    <script src="./js/d3.v3.min.js"></script>
  <!--tooltip js/css-->
    <link rel="stylesheet" type="text/css" href="css/tooltip-classic.css" />
</head>

<body class>
<!--
=============prepare===============
-->
<script>
var test;
if((document.all ? 'IE' : 'others') == 'IE'){
    alert('很抱歉，我们暂不支持IE浏览器，请使用其他浏览器');
    document.execCommand("Stop")
}
function getSize(){
    var pageWidth = window.innerWidth;
    var pageHeight = window.innerHeight; 
    if(typeof(pageWidth) != "number"){ 
        if(document.compatMode == "number"){ 
        pageWidth = document.documentElement.clientWidth; 
        pageHeight = document.documentElement.clientHeight; 
        }else{ 
        pageWidth = document.body.clientWidth; 
        pageHeight = document.body.clientHeight; 
        } 
    }
    var p = {
      'height': pageHeight,
      'width': pageWidth
    }
    return p;
}

var winSize = getSize();
</script>


<div id="layout">

    <a href="#menu" id="menuLink" class="menu-link">
        <!-- Hamburger icon -->
        <span></span>
    </a>

    <div id="menu">
        <div class="pure-menu">
            <a class="pure-menu-heading" href="#">College</a>

            <ul class="pure-menu-list">

                <li class="pure-menu-item selectParam">
                      <span class="tooltip tooltip-effect-1">
                        <a href="#" class="pure-menu-link tooltip-item"><i class="fa fa-check-square fa-3x"></i><span>选择参数</span></a>
                        <div class="tooltip-content clearfix"></div>
                      </span>
                </li>

                <li class="pure-menu-item universityType">
                      <span class="tooltip tooltip-effect-1">
                        <a href="#" class="pure-menu-link tooltip-item"><i class="fa fa-university fa-3x"></i><span>学校类型</span></a>
                        <div class="tooltip-content clearfix">
                          <form class="pure-form pure-form-stacked">
                              <fieldset>
                                <input id = "type-all" type = "checkbox" checked = "true" hidden onclick = "type_all(this.checked)"/>
                                <label for = "type-all" class = "type-all">全选</label>
                                <div id = "type-list"></div>
                              </fieldset>
                          </form>
                        </div>
                      </span>
                </li>

                <li class="pure-menu-item universityRegion" class="menu-item-divided pure-menu-selected">
                  <span class="tooltip tooltip-effect-1">
                        <a href="#" class="pure-menu-link tooltip-item"><i class="fa fa-map-marker fa-3x"></i><span>学校地区</span></a>
                        <div class="tooltip-content clearfix"></div>
                    </span>
                </li>
                <li class="pure-menu-item"><a href="#" class="pure-menu-link"><i class="fa fa-cloud-download fa-3x"></i><span>下载</span></a></li>
            </ul>
        </div>
    </div><!--menu end-->

    <div id="main">
        <div class="header">
            <h1 class="content-subhead">RANK POST</h1>
        </div>

        <div class="content">
              <div class="posts">   
              </div>
        </div>
    </div><!---main end-->

</div><!--layout end-->

<script src="js/pureUI.js"></script>
<!--drag/hover/-->
<script src="js/behaviors.js"></script>

<script>
$(document).ready = drawTreeMap();

var geoUnivCount = {};//统计省份数量
var rankArray=["综合指标（校友会网）_科学研究","综合指标（校友会网）_人才培养","综合指标（校友会网）_综合声誉"];//rankingd初始化

d3.csv("data/all.csv", function(error, data) {
  drawMainRank(data);
  drawGeoMap(geoUnivCount);
})


/*
*draw main rank
*/
    function drawMainRank(data){
        var color = d3.scale.ordinal()
                         .range(["#557381","#cc7f9d","#aeafbf","#eec6ad","#746b7e","#76b0bb","#da8082","#bd96cb","#c5bcaf","#b5c1cf","#a1c5ad","#6e99a2","#3b525a","#9e9dba","#dd9d9c"]);
        var margin = {top: 20, right: 20, bottom: 30, left: 40},
              width = 960 - margin.left - margin.right,
              height = 3000 - margin.top - margin.bottom;

        var x = d3.scale.linear()
            .rangeRound([0, width]);

        var y = d3.scale.ordinal()
            .rangeRoundBands([0, height], .1);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("top")
            .tickFormat(d3.format(".2s"));//?

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        var svg = d3.select("body").select(".content").select(".posts").append("svg")
            .attr("width", winSize.width*0.6)
            .attr("height", winSize.height)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // data/all.csv data
        //color.domain(d3.keys(rankArray));
          color.domain(d3.keys(data[0]).filter(function(key) { return (key !== "name")&&(key !== "type")&&(key !== "province"); }));

          data.forEach(function(d) {
            var x0 = 0;
            d.param = color.domain().map(function(paramName) {return {paramName: paramName, x0: x0, x1: x0 += +d[paramName]}; });
            d.score = d.param[d.param.length - 1].x1;//total points
          });

          data.sort(function(a, b) { return b.score - a.score; });

          x.domain([0, d3.max(data, function(d) { return d.score; })]);//bar length
          y.domain(data.map(function(d) { return d.name; }));//university's name

          svg.append("g")
              .attr("class", "x axis")
              //.attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          svg.append("g")
              .attr("class", "y axis")
              .call(yAxis)
              .append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", 6)
              .attr("width",20)
              .attr("dy", ".71em")
              .style("text-anchor", "end");

          var university = svg.selectAll(".university")
              .data(data)
              .enter().append("g")
              .attr("class", "university")
              .attr("transform", function(d) { return "translate(0," + y(d.name) + ")"; });

          university.selectAll("rect")
              .data(function(d) { return d.param; })
            .enter().append("rect")
              .attr("height", /*y.rangeBand()*/20)
              .attr("x", function(d) { return x(d.x0); })
              .attr("width", function(d) { return x(d.x1) - x(d.x0); })
              .style("fill", function(d) { return color(d.paramName); });

          for(var i=0; i<data.length;i++){
            if(geoUnivCount[data[i].province]==null){
              geoUnivCount[data[i].province] = {"name":data[i].province,count:0};   
            }
            geoUnivCount[data[i].province].count++;
          }//统计了省份中学校的数量

    }//function drawMainRank()

/*
*draggable treemap
*/
     function drawTreeMap(){
          var treemapColor = d3.scale.ordinal()
                                   .range(["#CC7F9D","#EEC6AD","#76B0BB"]);

          var treemapWidth = 300,
                treemapHeight = 300;

          var treemap = d3.layout.treemap()
              .round(false)
              .size([treemapWidth, treemapHeight])
              .sticky(true)
              .value(function(d) { return d.size; });

          var treemapSvg = d3.select("body").select("#layout").select(".selectParam").select(".tooltip-content").append("div")
              .attr("class", "selectBoard")
              .style("position", "relative")
              .style("float", "left")
              .style("width", treemapWidth + "px")
              .style("height", treemapHeight + "px")
              .append("svg:svg")
              .attr("width", treemapWidth)
              .attr("height", treemapHeight)
              .append("svg:g")
              .attr("transform", "translate(.5,.5)");

          d3.json("data/flare.json", function(error, root) {
              var nodes = treemap.nodes(root)
                  .filter(function(d) {
                   return !d.children; });
              var cell = treemapSvg.selectAll("g")
                  .data(nodes)
                  .enter().append("svg:g")
                  .attr("class", "cell")
                  .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
                  .on("mouseover",function(d,i){
                            d3.select(this).select("rect")
                               .style("fill","#f92572");
                   })
                  .on("click", function(d) {
                         if(d3.select(this).select("rect").attr("class")=="clickFlagOn"){
                            d3.select(this).select("rect")
                              .attr("class","clickFlagOff")
                              .style("fill",function(d) { return treemapColor(d.parent.name); });
                          }else{
                            d3.select(this).select("rect")
                              .attr("class","clickFlagOn")
                              .style("fill", "#f92572");
                          }
                  })
                  .on("mouseout",function(d,i){
                            d3.select(this).select("rect")
                              .style("fill", function(d) { 
                                if(d3.select(this).attr("class")=="clickFlagOn"){
                               // if ($(this).hasClass('clickFlagOn')) {
                                      return "#f92572"; 
                                }else{return treemapColor(d.parent.name); }
                                
                              })
                     })
                  .call(treemapDrag);

              cell.append("svg:rect")
                  .attr("width", function(d) { return d.dx - 1; })
                  .attr("height", function(d) { return d.dy - 1; })
                  .attr("class","clickFlagOff")
                  .style("fill", function(d) { return treemapColor(d.parent.name); });

              cell.append("svg:text")
                  .attr("x", function(d) { return d.dx / 2; })
                  .attr("y", function(d) { return d.dy / 2; })
                  .attr("dy", ".35em")
                  .attr("text-anchor", "middle")
                  .text(function(d) { return d.name; });
          });

     }//function drawTreeMap()


/*
*selectable region
*/
      var region = {
        "西北": ["新疆", "甘肃", "宁夏", "青海", "陕西"],
        "东北": ["黑龙江", "吉林", "辽宁"],
        "华北": ["北京", "天津", "河北", "山西", "内蒙古"],
        "华中": ["河南", "湖北", "湖南"],
        "华南": ["广东", "广西", "海南"],
        "华东": ["山东", "江苏", "安徽", "上海", "浙江", "江西", "福建"],
        "西南": ["重庆", "四川", "贵州", "云南", "西藏"],
      }




/*
*draggable chinamap
*/
      function drawGeoMap(geoUnivCount){
            var geomapWidth  = 500;
            var geomapHeight = 500;
            
            var geomapSvg = d3.select("body").select("#layout").select(".universityRegion").select(".tooltip-content").append("div")
                        .attr("class", "selectBoard")
                        .style("position", "relative")
                        .style("float", "left")
                        .style("width", geomapWidth + "px")
                        .style("height", geomapHeight + "px")
                        .append("svg:svg")
                        .attr("width", geomapWidth)
                        .attr("height", geomapHeight)
                        .append("svg:g")
                        .attr("transform", "translate(.5,.5)");
            
            var projection = d3.geo.mercator()
                      .center([105, 35])
                      .scale(450)
                      .translate([geomapWidth/2, geomapHeight/2]);
            
            var geomapPath = d3.geo.path()
                    .projection(projection);
            
            d3.json("data/geoChina.json", function(error, root) {
              
              if (error) 
                return console.error(error);
              
              geomapSvg.selectAll("geomapPath")
                .data( root.features )
                .enter()
                .append("path")
                .attr("stroke","#000")
                .attr("stroke-width",2)
                .style("fill", function(d,i){
                  var geoUniv = geoUnivCount[d.properties.name];
                          if(geoUniv == null){
                            return "#000";
                          }else{
                            if(geoUniv.count*0.1>1){
                              return "rgba(249,38,114,1.0)";
                            }
                            return "rgba(249,38,114," + geoUniv.count*0.1 + ")";
                          }
                })
                .attr("d", geomapPath)
                .on("mouseover",function(d,i){
                          d3.select(this)
                             .style("fill","#f7fcf0");
                 })
                 .on("mouseout",function(d,i){
                          d3.select(this)
                          .style("fill", function(d,i){
                                  var geoUniv = geoUnivCount[d.properties.name];
                                          if(geoUniv == null){
                                            return "#000";
                                          }else{
                                            if(geoUniv.count*0.1>1){
                                              return "rgba(249,38,114,1.0)";
                                            }
                                            return "rgba(249,38,114," + geoUniv.count*0.1 + ")";
                                          }
                            })
                   })
                  .call(treemapDrag);
              });
      }

</script>

</body>
</html>